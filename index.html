<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart School Pro - H·ªá Th·ªëng Qu·∫£n L√Ω Gi√°o D·ª•c</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <div class="auth-card">
            <h2 style="color:#1e293b; margin-bottom:5px"><i class="fas fa-school"></i> Smart School</h2>
            <p style="color:#64748b; margin-bottom:20px">H·ªá th·ªëng qu·∫£n l√Ω gi√°o d·ª•c</p>

            <div id="form-login">
                <h3 style="margin-bottom:15px; color:var(--primary)">ƒêƒÉng Nh·∫≠p</h3>
                <input type="email" id="login-email" class="auth-inp" placeholder="Email">
                <input type="password" id="login-pass" class="auth-inp" placeholder="M·∫≠t kh·∫©u">
                <button class="btn-auth" onclick="handleLogin()">ƒêƒÉng Nh·∫≠p</button>
                <div style="margin-top:15px; font-size:0.85rem; color:#94a3b8; text-align:center">
                    <i class="fas fa-info-circle"></i> T√†i kho·∫£n ƒë∆∞·ª£c c·∫•p b·ªüi Qu·∫£n tr·ªã vi√™n nh√† tr∆∞·ªùng
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-container" class="hidden">
        <aside class="sidebar">
            <div class="brand"><i class="fas fa-graduation-cap"></i> Smart School</div>
            <nav class="menu" id="main-menu">
                <!-- Dynamic menu based on role -->
            </nav>
            <div style="padding:1rem; border-top:1px solid #334155">
                <button class="btn btn-danger" style="width:100%" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </button>
            </div>
        </aside>

        <main class="main">
            <div class="top-bar">
                <h2 id="page-title">Dashboard</h2>
                <div style="display:flex; align-items:center; gap:15px">
                    <span id="user-info"></span>
                </div>
            </div>

            <div class="content-area" id="content">
                <!-- Dynamic content -->
            </div>
        </main>
    </div>


    <!-- MODAL: TIMETABLE EDIT -->
    <div id="modal-timetable" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-alt"></i> Ch·ªânh s·ª≠a ti·∫øt h·ªçc</h3>
                <button class="btn btn-outline" onclick="closeModal('modal-timetable')">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="timetable-form" onsubmit="saveTimetableSlot(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>M√¥n h·ªçc</label>
                            <select name="subject" class="form-control" id="timetable-subject" required>
                                <option value="">-- Ch·ªçn m√¥n --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Gi√°o vi√™n</label>
                            <input type="text" name="teacher" class="form-control" placeholder="T√™n gi√°o vi√™n">
                        </div>
                        <div class="form-group">
                            <label>Ph√≤ng h·ªçc</label>
                            <input type="text" name="room" class="form-control" placeholder="VD: P101">
                        </div>
                    </div>
                    <div style="text-align:right; margin-top:20px">
                        <button type="button" class="btn btn-outline" onclick="closeModal('modal-timetable')">H·ªßy</button>
                        <button type="button" class="btn btn-danger" onclick="clearTimetableSlot()">
                            <i class="fas fa-trash"></i> X√≥a ti·∫øt
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> L∆∞u
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: SCHEDULE SETTINGS -->
    <div id="modal-schedule-settings" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3><i class="fas fa-clock"></i> C√†i ƒë·∫∑t Th·ªùi gian Ti·∫øt h·ªçc</h3>
                <button class="btn btn-outline" onclick="closeModal('modal-schedule-settings')">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                    <strong>üìå L∆∞u √Ω:</strong> Thay ƒë·ªïi s·∫Ω √°p d·ª•ng cho t·∫•t c·∫£ c√°c l·ªõp. ƒê·ªãnh d·∫°ng th·ªùi gian: HH:MM-HH:MM (VD: 7:30-8:10)
                </div>
                
                <div class="form-section">
                    <h4>‚õÖ Bu·ªïi S√°ng</h4>
                    <div id="morning-periods-container"></div>
                    <button type="button" class="btn btn-sm btn-success" onclick="addPeriod('morning')" style="margin-top:10px">
                        <i class="fas fa-plus"></i> Th√™m ti·∫øt
                    </button>
                </div>
                
                <div class="form-section">
                    <h4>üåô Bu·ªïi Chi·ªÅu</h4>
                    <div id="afternoon-periods-container"></div>
                    <button type="button" class="btn btn-sm btn-success" onclick="addPeriod('afternoon')" style="margin-top:10px">
                        <i class="fas fa-plus"></i> Th√™m ti·∫øt
                    </button>
                </div>
                
                <div style="text-align:right; margin-top:25px; padding-top:20px; border-top: 1px solid #e2e8f0;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('modal-schedule-settings')">H·ªßy</button>
                    <button type="button" class="btn btn-warning" onclick="resetDefaultSchedule()">
                        <i class="fas fa-undo"></i> Kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveScheduleSettings()">
                        <i class="fas fa-save"></i> L∆∞u c√†i ƒë·∫∑t
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-student" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> <span id="modal-student-title">Th√™m H·ªçc Sinh</span></h3>
                <button class="btn btn-outline" onclick="closeModal('modal-student')">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="student-form" onsubmit="saveStudent(event)">
                    <div class="form-section">
                        <h4>Th√¥ng tin c∆° b·∫£n</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>M√£ h·ªçc sinh *</label>
                                <input type="text" name="code" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>H·ªç v√† t√™n *</label>
                                <input type="text" name="name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>L·ªõp *</label>
                                <input type="text" name="classRoom" class="form-control" placeholder="VD: 1A, 2B" required>
                            </div>
                            <div class="form-group">
                                <label>Gi·ªõi t√≠nh</label>
                                <select name="gender" class="form-control">
                                    <option value="Nam">Nam</option>
                                    <option value="N·ªØ">N·ªØ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ng√†y sinh</label>
                                <input type="date" name="dob" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Tr·∫°ng th√°i *</label>
                                <select name="status" class="form-control" required>
                                    <option value="active">ƒêang h·ªçc</option>
                                    <option value="leave">Ngh·ªâ h·ªçc</option>
                                    <option value="reserved">B·∫£o l∆∞u</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>SƒêT Kh·∫©n c·∫•p</label>
                                <input type="tel" name="sosPhone" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Th√¥ng tin Ph·ª• huynh</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>H·ªç t√™n Cha</label>
                                <input type="text" name="dadName" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>SƒêT Cha</label>
                                <input type="tel" name="dadPhone" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>H·ªç t√™n M·∫π</label>
                                <input type="text" name="momName" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>SƒêT M·∫π</label>
                                <input type="tel" name="momPhone" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div style="text-align:right; margin-top:20px">
                        <button type="button" class="btn btn-outline" onclick="closeModal('modal-student')">H·ªßy</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> L∆∞u
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-finance" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-money-bill-wave"></i> <span id="modal-finance-title">Th√™m Kho·∫£n Thu/Chi</span></h3>
                <button class="btn btn-outline" onclick="closeModal('modal-finance')">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="finance-form" onsubmit="saveFinance(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Lo·∫°i giao d·ªãch *</label>
                            <select name="type" class="form-control" required onchange="toggleFinanceCategory()">
                                <option value="income">Thu</option>
                                <option value="expense">Chi</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Danh m·ª•c *</label>
                            <select name="category" class="form-control" required id="finance-category">
                                <optgroup label="Thu">
                                    <option value="tuition">H·ªçc ph√≠</option>
                                    <option value="exam_fee">Ph√≠ thi</option>
                                    <option value="uniform">ƒê·ªìng ph·ª•c</option>
                                    <option value="meal">Ti·ªÅn ƒÉn</option>
                                    <option value="other_income">Thu kh√°c</option>
                                </optgroup>
                                <optgroup label="Chi">
                                    <option value="salary">L∆∞∆°ng</option>
                                    <option value="utility">ƒêi·ªán n∆∞·ªõc</option>
                                    <option value="maintenance">B·∫£o tr√¨</option>
                                    <option value="supplies">VƒÉn ph√≤ng ph·∫©m</option>
                                    <option value="other_expense">Chi kh√°c</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>S·ªë ti·ªÅn (VNƒê) *</label>
                            <input type="number" name="amount" class="form-control" required min="0">
                        </div>
                        <div class="form-group">
                            <label>Ng√†y giao d·ªãch *</label>
                            <input type="date" name="date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>M√£ h·ªçc sinh (n·∫øu c√≥)</label>
                            <input type="text" name="studentCode" class="form-control" placeholder="VD: HS001">
                        </div>
                        <div class="form-group">
                            <label>Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                            <select name="paymentMethod" class="form-control">
                                <option value="cash">Ti·ªÅn m·∫∑t</option>
                                <option value="bank">Chuy·ªÉn kho·∫£n</option>
                                <option value="card">Th·∫ª</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="custom-income-field" style="display:none">
                        <label>N·ªôi dung thu *</label>
                        <input type="text" name="customIncome" class="form-control" placeholder="Nh·∫≠p n·ªôi dung kho·∫£n thu">
                    </div>
                    <div class="form-group">
                        <label>Ghi ch√∫</label>
                        <textarea name="note" class="form-control" rows="3"></textarea>
                    </div>
                    <div style="text-align:right; margin-top:20px">
                        <button type="button" class="btn btn-outline" onclick="closeModal('modal-finance')">H·ªßy</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> L∆∞u
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-score" class="modal">
        <div class="modal-content" style="max-width: 1400px;">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Nh·∫≠p ƒêi·ªÉm - <span id="score-student-name"></span></h3>
                <button class="btn btn-outline" onclick="closeModal('modal-score')">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:20px">
                    <label style="font-weight:600; margin-right:10px">Ch·ªçn H·ªçc k·ª≥:</label>
                    <select id="score-semester" class="custom-select" onchange="loadScoreForm()">
                        <option value="1">H·ªçc k·ª≥ 1</option>
                        <option value="2">H·ªçc k·ª≥ 2</option>
                    </select>
                </div>
                <div id="score-form-container"></div>
                <div style="text-align:right; margin-top:20px">
                    <button class="btn btn-outline" onclick="closeModal('modal-score')">H·ªßy</button>
                    <button class="btn btn-success" onclick="saveScores()">
                        <i class="fas fa-save"></i> L∆∞u ƒëi·ªÉm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: CREATE USER (Admin only) -->
    <div id="modal-create-user" class="modal">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> T·∫°o T√†i Kho·∫£n M·ªõi</h3>
                <button class="btn btn-outline" onclick="closeModal('modal-create-user')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="cu-email" class="form-control" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label>M·∫≠t kh·∫©u *</label>
                    <input type="password" id="cu-pass" class="form-control" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±">
                </div>
                <div class="form-group">
                    <label>Vai tr√≤ *</label>
                    <select id="cu-role" class="form-control" onchange="toggleCreateUserFields()">
                        <option value="" disabled selected>-- Ch·ªçn vai tr√≤ --</option>
                        <option value="teacher">Gi√°o vi√™n</option>
                        <option value="parent">Ph·ª• huynh</option>
                        <option value="admin">Qu·∫£n tr·ªã vi√™n (Admin)</option>
                    </select>
                </div>
                <div id="cu-class-group" class="form-group hidden">
                    <label>L·ªõp ph·ª• tr√°ch *</label>
                    <input type="text" id="cu-class" class="form-control" placeholder="VD: 1A, 2B, 3C">
                </div>
                <div id="cu-student-group" class="form-group hidden">
                    <label>M√£ h·ªçc sinh c·ªßa con *</label>
                    <input type="text" id="cu-student-id" class="form-control" placeholder="VD: HS001, HS002">
                </div>
                <div style="background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px; padding:12px; margin-top:10px; font-size:0.85rem; color:#166534">
                    <i class="fas fa-info-circle"></i> T√†i kho·∫£n s·∫Ω ƒë∆∞·ª£c t·∫°o ngay. H√£y g·ª≠i th√¥ng tin ƒëƒÉng nh·∫≠p cho ng∆∞·ªùi d√πng.
                </div>
                <div style="text-align:right; margin-top:20px; display:flex; gap:10px; justify-content:flex-end">
                    <button class="btn btn-outline" onclick="closeModal('modal-create-user')">H·ªßy</button>
                    <button class="btn btn-primary" onclick="adminCreateUser()">
                        <i class="fas fa-user-plus"></i> T·∫°o t√†i kho·∫£n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: ATTENDANCE STATISTICS -->
    <div id="modal-attendance-stats" class="modal">
        <div class="modal-content" style="max-width:950px">
            <div class="modal-header">
                <h3><i class="fas fa-chart-bar"></i> Th·ªëng K√™ ƒêi·ªÉm Danh</h3>
                <button class="btn btn-outline" onclick="closeModal('modal-attendance-stats')">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:flex-end">
                    <div class="form-group" style="margin-bottom:0; flex:1; min-width:140px">
                        <label>T·ª´ ng√†y</label>
                        <input type="date" id="stats-from-date" class="form-control">
                    </div>
                    <div class="form-group" style="margin-bottom:0; flex:1; min-width:140px">
                        <label>ƒê·∫øn ng√†y</label>
                        <input type="date" id="stats-to-date" class="form-control">
                    </div>
                    <div id="stats-class-filter-wrap" class="form-group" style="margin-bottom:0; flex:1; min-width:140px">
                        <label>L·ªõp</label>
                        <select id="stats-class-filter" class="form-control">
                            <option value="">T·∫•t c·∫£ l·ªõp</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="loadAttendanceStats()">
                        <i class="fas fa-search"></i> Th·ªëng k√™
                    </button>
                </div>
                <div id="attendance-stats-result"></div>
            </div>
        </div>
    </div>

    <!-- Firebase & App Script -->
    <script type="module" src="app.js"></script>
</body>
</html>
